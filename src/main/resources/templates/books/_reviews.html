<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<body>

<div th:fragment="reviews-section">
  <!-- User's Own Review Section -->
  <div sec:authorize="isAuthenticated()">
    <div th:if="${userReview != null}">
      <div th:replace="~{books/_user-review :: user-review-display}"></div>
      <!-- Edit and Delete Buttons for User's Own Review -->
      <div class="mt-2">
        <form th:action="@{/reviews/{id}/delete(id=${userReview.id})}" method="post" style="display:inline;">
          <input type="hidden" name="_method" value="delete"/>
          <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this review?');">Delete</button>
        </form>
      </div>
    </div>
    <div th:if="${userReview == null}">
      <h4>Write a Review</h4>
      <div th:replace="~{books/_review-form :: review-form(formAction=@{/reviews/add}, formObjectId='feedbackRequest', submitButtonText='Submit Review')}"></div>
    </div>
  </div>

  <!-- Login/Register prompt for non-authenticated users -->
  <div sec:authorize="!isAuthenticated()">
    <div class="card bg-light">
      <div class="card-body text-center">
        <p class="text-muted mb-0">
          <a th:href="@{/login}">Login</a> or <a th:href="@{/register}">Register</a> to write a review.
        </p>
      </div>
    </div>
  </div>

  <hr class="my-4">

  <!-- All Community Reviews -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Community Reviews <span class="badge bg-secondary" th:text="${reviews.totalElements}"></span></h4>
    <div>
      <!-- Sorting Controls -->
      <a th:href="@{/books/{id}(id=${book.id}, sort='rating', dir=${sortField == 'rating' && sortDir == 'desc' ? 'asc' : 'desc'})}" class="btn btn-sm btn-outline-secondary">
        Rating <i class="bi" th:classappend="${sortField == 'rating' ? (sortDir == 'desc' ? 'bi-sort-down' : 'bi-sort-up') : 'bi-sort-down-alt'}"></i>
      </a>
      <a th:href="@{/books/{id}(id=${book.id}, sort='createdAt', dir=${sortField == 'createdAt' && sortDir == 'desc' ? 'asc' : 'desc'})}" class="btn btn-sm btn-outline-secondary ms-2">
        Date <i class="bi" th:classappend="${sortField == 'createdAt' ? (sortDir == 'desc' ? 'bi-sort-down' : 'bi-sort-up') : 'bi-sort-down-alt'}"></i>
      </a>
    </div>
  </div>

  <!-- Message for no reviews -->
  <div th:if="${reviews.isEmpty()}" class="text-center text-muted p-3">
    <p>No community reviews yet. Be the first!</p>
  </div>

  <!-- Display list of reviews -->
  <div th:unless="${reviews.isEmpty()}">
    <div th:each="review : ${reviews.content}" class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <h6 class="card-title" th:text="${review.firstName}">User Name</h6>
          <div class="star-rating">
            <span th:each="i : ${#numbers.sequence(1, 5)}">
              <i class="bi" th:classappend="${i <= review.rating} ? 'bi-star-fill' : 'bi-star'"></i>
            </span>
          </div>
        </div>
        <p class="card-text" th:text="${review.comment}">Review comment.</p>
        <small class="text-muted" th:text="'Reviewed on ' + ${#temporals.format(review.createdAt, 'MMMM dd, yyyy')}">Date</small>
        <!-- Edit and Delete Buttons for Review Owner or Admin -->
        <div class="mt-2" sec:authorize="isAuthenticated()">
          <div sec:authorize="hasRole('ROLE_ADMIN')">
            <form th:action="@{/reviews/{id}/delete(id=${review.id})}" method="post" style="display:inline;">
              <input type="hidden" name="_method" value="delete"/>
              <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this review?');">Delete</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination Controls -->
    <nav th:if="${reviews.totalPages > 1}">
      <ul class="pagination justify-content-center">
        <li class="page-item" th:classappend="${reviews.first} ? 'disabled'">
          <a class="page-link" th:href="@{/books/{id}(id=${book.id}, page=${reviews.number-1}, sort=${sortField}, dir=${sortDir})}">Previous</a>
        </li>
        <li class="page-item" th:each="i : ${#numbers.sequence(0, reviews.totalPages - 1)}" th:classappend="${i == reviews.number} ? 'active'">
          <a class="page-link" th:href="@{/books/{id}(id=${book.id}, page=${i}, sort=${sortField}, dir=${sortDir})}" th:text="${i+1}"></a>
        </li>
        <li class="page-item" th:classappend="${reviews.last} ? 'disabled'">
          <a class="page-link" th:href="@{/books/{id}(id=${book.id}, page=${reviews.number+1}, sort=${sortField}, dir=${sortDir})}">Next</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

</body>
</html>